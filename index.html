<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>microCMS プレビュー</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="https://unpkg.com/microcms-js-sdk@latest/dist/umd/microcms-js-sdk.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* 日本語フォントと基本的なスタイルを適用 */
        html {
            scroll-behavior: smooth; /* スムーズスクロールを有効化 */
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: #333; /* 基本の文字色を濃いグレーに */
            background-color: #f9fafb; /* 背景色を少しグレーに */
        }

        /* Markdownから変換されたHTML要素のスタイル調整 */
        .prose h1 {
            font-size: 1.875rem; /* text-3xl */
            line-height: 2.5rem;
            font-weight: 700;
            color: #1f2937; /* text-gray-800 */
            margin-bottom: 0.75rem;
            padding-bottom: 0;
            border-bottom: none;
        }
        @media (min-width: 768px) {
            .prose h1 {
                font-size: 2.25rem; /* md:text-4xl */
                line-height: 2.75rem;
            }
        }

        .prose h2 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700;
            color: #111827; /* text-gray-900 */
            margin-top: 3.5rem;
            margin-bottom: 1.5rem;
            padding-left: 1rem;
            border-left: 5px solid #3b82f6; /* Blue-500 */
            border-bottom: none;
        }

        .prose h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700;
            color: #111827; /* text-gray-900 */
            margin-top: 3rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb; /* border-gray-200 */
        }

        .prose p {
            font-size: 1rem;
            line-height: 2; /* 行間を広げて読みやすく */
            margin-bottom: 1.5rem;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.75rem;
            margin-bottom: 1.5rem;
        }

        .prose li {
            margin-bottom: 0.75rem;
            line-height: 2;
        }

        .prose strong {
            font-weight: 700;
            color: #111827;
        }

        .prose a {
            color: #2563eb; /* blue-600 */
            text-decoration: underline;
            transition: color 0.2s;
        }
        .prose a:hover {
            color: #1d4ed8; /* blue-700 */
        }

        .prose blockquote {
            border-left: 4px solid #d1d5db;
            padding-left: 1rem;
            color: #4b5563; /* 少し濃いグレーに */
            margin-bottom: 1.5rem;
            font-style: italic;
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto max-w-5xl px-4 py-4">
            <h1 class="text-xl font-bold text-gray-700">記事プレビュー</h1>
        </div>
    </header>

    <main class="container mx-auto max-w-4xl px-4 py-8 sm:py-16">
        <article id="article-container" class="prose max-w-none bg-white p-6 sm:p-10 md:p-12 rounded-xl shadow-lg">
            <div class="not-prose mb-10 pb-8 border-b border-gray-200">
                <div id="article-meta">
                    <h1 id="article-title" class="text-gray-400 text-3xl md:text-4xl font-bold">データを読み込み中...</h1>
                    <time id="article-published-at" class="block mt-4 text-gray-500 text-base"></time>
                    <p id="article-description" class="mt-6 text-gray-600 text-lg leading-relaxed"></p>
                </div>
            </div>

            <div id="toc-container" class="not-prose hidden mb-12 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                <h2 class="text-lg font-bold mb-4 flex items-center text-blue-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
                    目次
                </h2>
                <ol id="table-of-contents" class="space-y-2"></ol>
            </div>

            <div id="article-body" class="text-gray-400">
                <p>microCMSからプレビューデータを取得しています。しばらくお待ちください。</p>
            </div>

            <div id="article-supervisor-container" class="hidden not-prose mt-16 pt-8 border-t border-gray-200">
                <div class="bg-gray-50 p-6 rounded-lg">
                    <p class="text-sm text-gray-500 mb-2">この記事の監修者</p>
                    <p id="article-supervisor" class="text-xl font-bold text-gray-800"></p>
                </div>
            </div>
        </article>
    </main>

    <footer class="bg-gray-800 text-white mt-16 py-6">
        <div class="container mx-auto max-w-5xl px-4 text-center text-sm">
            &copy; 2023 My Website. All Rights Reserved.
        </div>
    </footer>


    <script>
        // --- 設定項目 ---
        const SERVICE_DOMAIN = 'anicure-dev';
        const API_KEY = '89b2759d3aa84128a5726ccf46c4fa605b07';
        const API_ENDPOINT = 'articles';

        // --- フィールドIDの設定 ---
        const TITLE_FIELD_ID = 'title';
        const DESCRIPTION_FIELD_ID = 'description';
        const BODY_FIELD_ID = 'body';
        const SUPERVISOR_FIELD_ID = 'supervisor';
        const PUBLISHED_AT_FIELD_ID = 'publishedAt';

        const client = microcms.createClient({
            serviceDomain: SERVICE_DOMAIN,
            apiKey: API_KEY,
        });

        // 目次を生成する関数
        const createTableOfContents = (bodyElement) => {
            const tocContainer = document.getElementById('toc-container');
            const tocList = document.getElementById('table-of-contents');
            tocList.innerHTML = ''; // 既存の目次をクリア

            const headings = bodyElement.querySelectorAll('h2, h3');

            if (headings.length === 0) {
                tocContainer.classList.add('hidden');
                return;
            }

            headings.forEach((heading, index) => {
                const id = `toc-${index}`;
                heading.id = id;

                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#${id}`;
                a.textContent = heading.textContent;
                a.className = "hover:underline transition-colors";

                // h2かh3かでスタイルを調整
                if (heading.tagName === 'H2') {
                    li.classList.add('font-semibold', 'text-blue-700');
                } else if (heading.tagName === 'H3') {
                    li.classList.add('ml-4', 'text-blue-600');
                }

                li.appendChild(a);
                tocList.appendChild(li);
            });

            tocContainer.classList.remove('hidden');
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const titleElement = document.getElementById('article-title');
            const publishedAtElement = document.getElementById('article-published-at');
            const descriptionElement = document.getElementById('article-description');
            const bodyElement = document.getElementById('article-body');
            const supervisorContainer = document.getElementById('article-supervisor-container');
            const supervisorElement = document.getElementById('article-supervisor');

            try {
                const params = new URLSearchParams(window.location.search);
                const contentId = params.get('contentId');
                const draftKey = params.get('draftKey');

                if (!contentId || !draftKey) {
                    throw new Error('プレビュー用のパラメータが見つかりません。');
                }

                const data = await client.get({
                    endpoint: API_ENDPOINT,
                    contentId: contentId,
                    queries: { draftKey: draftKey },
                });

                // 1. タイトルを設定
                if (data[TITLE_FIELD_ID]) {
                    titleElement.textContent = data[TITLE_FIELD_ID];
                    document.title = `${data[TITLE_FIELD_ID]} | microCMS プレビュー`;
                    titleElement.classList.remove('text-gray-400');
                } else {
                    titleElement.textContent = 'タイトルの取得に失敗';
                }

                // 2. 公開日を設定
                if (data[PUBLISHED_AT_FIELD_ID]) {
                    const date = new Date(data[PUBLISHED_AT_FIELD_ID]);
                    const formattedDate = `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
                    publishedAtElement.textContent = `公開日: ${formattedDate}`;
                    publishedAtElement.setAttribute('datetime', data[PUBLISHED_AT_FIELD_ID]);
                }

                // 3. 概要を設定
                if (data[DESCRIPTION_FIELD_ID]) {
                    descriptionElement.textContent = data[DESCRIPTION_FIELD_ID];
                }

                // 4. 本文（Markdown）をHTMLに変換して設定
                if (data[BODY_FIELD_ID]) {
                    bodyElement.innerHTML = marked.parse(data[BODY_FIELD_ID]);
                    bodyElement.classList.remove('text-gray-400');

                    // 本文がレンダリングされた後に目次を生成
                    createTableOfContents(bodyElement);
                } else {
                    bodyElement.innerHTML = '<p>本文の取得に失敗しました。フィールドIDが正しいか確認してください。</p>';
                }

                // 5. 監修者を設定
                if (data[SUPERVISOR_FIELD_ID]) {
                    const supervisorData = data[SUPERVISOR_FIELD_ID];
                    let supervisorName = '';

                    if (typeof supervisorData === 'object' && supervisorData !== null) {
                         // APIのレスポンスに合わせて 'name' または 'title' を使用
                        supervisorName = supervisorData.name || supervisorData.title || '監修者名の取得に失敗';
                    } else if (typeof supervisorData === 'string') {
                        supervisorName = supervisorData;
                    }

                    if (supervisorName) {
                        supervisorElement.textContent = supervisorName;
                        supervisorContainer.classList.remove('hidden');
                    }
                }

            } catch (error) {
                console.error('プレビューの読み込みに失敗しました:', error);
                const articleContainer = document.getElementById('article-container');
                articleContainer.innerHTML = `
                    <div class="text-center">
                        <h1 class="text-2xl font-bold text-red-600">エラーが発生しました</h1>
                        <p class="mt-4">プレビューの読み込みに失敗しました。</p>
                        <p class="mt-2 text-sm text-red-500 bg-red-50 p-4 rounded-md">エラー内容: ${error.message}</p>
                        <p class="mt-6 text-sm text-gray-600">設定項目（サービスドメイン、APIキー、エンドポイント名、各フィールドID）が正しいか確認してください。</p>
                    </div>`;
            }
        });
    </script>
</body>
</html>
