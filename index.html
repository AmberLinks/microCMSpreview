<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>microCMS プレビュー</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script src="https://unpkg.com/microcms-js-sdk@latest/dist/umd/microcms-js-sdk.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Noto Sans JP', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background-color: #f5f7fb;
      color: #1f2937;
    }
    .article-prose p { line-height: 2; margin: 1.1rem 0; }
    .article-prose a { color: #2563eb; text-decoration: underline; }
    .article-prose ul { list-style: disc; padding-left: 1.25rem; margin: 1rem 0; }
    .article-prose ol { list-style: decimal; padding-left: 1.25rem; margin: 1rem 0; }
    .article-prose strong { font-weight: 700; }
    .article-prose img { max-width: 100%; height: auto; border-radius: .5rem; }
    .section-h2 {
      font-size: clamp(1.25rem, 2.2vw, 1.75rem); font-weight: 900; margin-top: 3rem; margin-bottom: 1.25rem;
      padding: .9rem 1rem; background: #eef2ff; color: #1e3a8a;
      border-left: .5rem solid #4f46e5; border-radius: .5rem;
    }
    .section-h3 {
      font-size: clamp(1.05rem, 2vw, 1.25rem); font-weight: 800; margin-top: 2.25rem; margin-bottom: .75rem;
      padding-bottom: .5rem; border-bottom: 2px solid #e5e7eb;
    }
    .summary-band {
      font-size: clamp(1.25rem, 2.2vw, 1.6rem); font-weight: 900; margin-top: 3rem; margin-bottom: 1.25rem;
      padding: 1rem 1.2rem; background: #f3f4f6; color: #111827;
      border-left: .6rem solid #111827; border-radius: .5rem;
    }
    #table-of-contents a:hover { text-decoration: underline; }
    h2[id], h3[id] { scroll-margin-top: 96px; }
  </style>
</head>
<body class="min-h-screen">

  <header class="bg-white/90 backdrop-blur sticky top-0 z-40 border-b border-gray-200">
    <div class="mx-auto max-w-6xl px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold text-gray-700">記事プレビュー</div>
        <div class="text-xs text-gray-500">microCMS Draft Preview</div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
    <div id="content-wrapper">
      <div id="loading-indicator" class="text-center py-12">
        <p>プレビューデータを読み込んでいます...</p>
        <p class="text-sm text-gray-500 mt-2">（URLに contentId と draftKey が含まれているか確認してください）</p>
      </div>
      
      <div id="main-content" class="hidden">
        <section class="mb-8 sm:mb-10">
          <div class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-100">
            <div class="px-5 sm:px-8 pt-7 pb-6 sm:pb-7">
              <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
                <h1 id="article-title" class="text-2xl sm:text-3xl md:text-4xl font-extrabold leading-snug text-gray-900"></h1>
                <div class="shrink-0 sm:text-right">
                  <time id="article-published-at" class="block text-sm text-gray-700"></time>
                  <time id="article-updated-at" class="block text-sm text-gray-500"></time>
                </div>
              </div>
              <p id="article-description" class="mt-5 text-gray-700 text-base sm:text-lg leading-8"></p>
            </div>
          </div>
        </section>

        <aside id="toc-container" class="hidden mb-10">
          <div class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-100 p-5 sm:p-6">
            <h2 class="text-base font-bold mb-3 flex items-center text-indigo-800">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
              目次
            </h2>
            <ol id="table-of-contents" class="space-y-2 text-[15px]"></ol>
          </div>
        </aside>

        <article id="article-container" class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-100 p-5 sm:p-8 md:p-10">
          <div id="article-body" class="article-prose text-gray-700"></div>

          <section id="article-author-container" class="hidden mt-14 pt-8 border-t border-gray-200">
            <div class="flex items-start gap-5">
              <img id="author-avatar" src="" alt="著者アイコン" class="h-16 w-16 rounded-full object-cover border-4 border-white shadow-md"/>
              <div class="flex-1">
                <p class="text-xs font-semibold text-gray-600 tracking-wide">筆者</p>
                <h3 id="author-name" class="text-lg font-bold text-gray-900 mt-1"></h3>
                <p id="author-bio" class="text-sm text-gray-700 mt-2 leading-7"></p>
                <a id="author-link" href="#" target="_blank" rel="noopener" class="inline-block mt-3 text-sm font-semibold text-indigo-700 hover:text-indigo-900 transition-colors">プロフィールを見る →</a>
              </div>
            </div>
          </section>

          <section id="article-supervisor-container" class="hidden mt-10">
            <div class="mt-8 p-6 rounded-xl bg-gray-50">
              <div class="flex items-start gap-5">
                <img id="supervisor-icon" src="" alt="監修者アイコン" class="h-16 w-16 rounded-full object-cover border-4 border-white shadow-md"/>
                <div class="flex-1">
                  <p id="supervisor-label" class="text-xs font-semibold text-gray-600 tracking-wide">監修</p>
                  <h3 id="supervisor-name" class="text-lg font-bold text-gray-900 mt-1"></h3>
                  <p id="supervisor-description" class="text-sm text-gray-700 mt-2 leading-7"></p>
                  <a id="supervisor-link" href="#" target="_blank" rel="noopener" class="inline-block mt-3 text-sm font-semibold text-indigo-700 hover:text-indigo-900 transition-colors">詳しくはこちら →</a>
                </div>
              </div>
            </div>
          </section>
        </article>
      </div>
    </div>
  </main>

  <footer class="bg-gray-900 text-white">
    <div class="mx-auto max-w-6xl px-4 py-6 text-center text-xs">
      &copy; 2025 My Website. All Rights Reserved.
    </div>
  </footer>

  <script>
    // ===== 設定 =====
    const SERVICE_DOMAIN = 'anicure-dev';
    const API_KEY        = '89b2759d3aa84128a5726ccf46c4fa605b07';

    // --- APIエンドポイント設定 ---
    const ARTICLE_ENDPOINT = 'articles';
    const STAFF_ENDPOINT   = 'staff'; // 著者・監修者が所属するAPIエンドポイント

    // --- 記事APIのフィールドID ---
    const ARTICLE_FIELD = {
      title:       'title',
      description: 'description',
      body:        'body',
      publishedAt: 'publishedAt',
      updatedAt:   'revisedAt',
      author:      'author',
      supervisor:  'supervisor'
    };
    
    // ===== ユーティリティ関数 =====
    const getImageUrl = (imgField) => (imgField && imgField.url) ? imgField.url : '';
    const formatYMD = (dateStr) => {
      if (!dateStr) return '';
      try { return new Date(dateStr).toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '.'); }
      catch { return ''; }
    };
    
    // ===== DOM操作 =====
    const decorateHeadings = (rootEl) => {
      rootEl.querySelectorAll('h2').forEach(h => h.classList.add((h.textContent || '').trim().startsWith('まとめ') ? 'summary-band' : 'section-h2'));
      rootEl.querySelectorAll('h3').forEach(h => h.classList.add('section-h3'));
    };

    const createToc = (bodyEl) => {
      const tocContainer = document.getElementById('toc-container');
      const tocList = document.getElementById('table-of-contents');
      const headings = bodyEl.querySelectorAll('h2, h3');
      if (!headings.length) { tocContainer.classList.add('hidden'); return; }
      
      tocList.innerHTML = '';
      headings.forEach((h, i) => {
        h.id = `toc-${i}`;
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `#${h.id}`;
        a.textContent = h.textContent;
        a.className = 'hover:underline';
        li.className = h.tagName === 'H2' ? 'font-semibold text-indigo-800' : 'ml-4 text-indigo-700';
        li.appendChild(a);
        tocList.appendChild(li);
      });
      tocContainer.classList.remove('hidden');
    };

    // 著者・監修者情報を表示する汎用関数
    const displayPersonInfo = async (client, personRef, endpoint, elements) => {
      if (!personRef || !personRef.id) return;
      try {
        const person = await client.get({ endpoint: endpoint, contentId: personRef.id });
        
        elements.container.classList.remove('hidden');
        elements.avatar.src = getImageUrl(person.anicureThumbnail);
        elements.name.textContent = person.name || '';
        elements.bio.textContent = person.anicureDescription || '';
        // ラベルやリンクが必要な場合はここで設定
        if (elements.label) {
            const role = (person.anicureRole || []).join(' / ');
            elements.label.textContent = role || '監修';
            elements.name.textContent = `${person.name || ''} ${role ? `(${role})` : ''}`;
        }
      } catch (e) {
        console.error(`${endpoint}情報の取得に失敗:`, e);
      }
    };
    
    // ===== メイン処理 =====
    document.addEventListener('DOMContentLoaded', async () => {
      const client = microcms.createClient({ serviceDomain: SERVICE_DOMAIN, apiKey: API_KEY });
      const wrapperEl = document.getElementById('content-wrapper');

      try {
        const params = new URLSearchParams(window.location.search);
        const contentId = params.get('contentId');
        const draftKey = params.get('draftKey');
        if (!contentId || !draftKey) throw new Error('プレビュー用のパラメータ（contentId, draftKey）がURLに含まれていません。microCMSのプレビュー機能からアクセスしてください。');

        // 1. 記事データを取得
        const article = await client.get({ endpoint: ARTICLE_ENDPOINT, contentId, queries: { draftKey } });
        
        // ローディング表示を消してメインコンテンツを表示
        document.getElementById('loading-indicator').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');

        // 2. 記事の基本情報を表示
        document.getElementById('article-title').textContent = article[ARTICLE_FIELD.title] || 'タイトル未設定';
        document.getElementById('article-published-at').textContent = `公開：${formatYMD(article[ARTICLE_FIELD.publishedAt])}`;
        document.getElementById('article-updated-at').textContent = `更新：${formatYMD(article[ARTICLE_FIELD.updatedAt])}`;
        document.getElementById('article-description').textContent = article[ARTICLE_FIELD.description] || '';

        // 3. 本文をレンダリング
        const bodyEl = document.getElementById('article-body');
        if (article[ARTICLE_FIELD.body]) {
          bodyEl.innerHTML = marked.parse(article[ARTICLE_FIELD.body]);
          decorateHeadings(bodyEl);
          createToc(bodyEl);
        } else {
          bodyEl.innerHTML = '<p>本文が設定されていません。</p>';
        }
        
        // 4. 著者情報を取得・表示
        await displayPersonInfo(client, article[ARTICLE_FIELD.author], STAFF_ENDPOINT, {
          container: document.getElementById('article-author-container'),
          avatar: document.getElementById('author-avatar'),
          name: document.getElementById('author-name'),
          bio: document.getElementById('author-bio'),
          link: document.getElementById('author-link')
        });

        // 5. 監修者情報を取得・表示
        await displayPersonInfo(client, article[ARTICLE_FIELD.supervisor], STAFF_ENDPOINT, {
          container: document.getElementById('article-supervisor-container'),
          avatar: document.getElementById('supervisor-icon'),
          name: document.getElementById('supervisor-name'),
          bio: document.getElementById('supervisor-description'),
          link: document.getElementById('supervisor-link'),
          label: document.getElementById('supervisor-label') // 監修者特有の要素
        });

      } catch (error) {
        console.error('プレビューの読み込みに失敗:', error);
        wrapperEl.innerHTML = `<div class="text-center py-12"><h1 class="text-2xl font-bold text-red-600">エラーが発生しました</h1><p class="mt-4">プレビューの読み込みに失敗しました。</p><p class="mt-3 text-sm text-red-700 bg-red-50 inline-block px-4 py-2 rounded-md">${error.message}</p></div>`;
      }
    });
  </script>
</body>
</html>
