<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>microCMS プレビュー</title>
    
    <!-- Tailwind CSS: スタイリング用 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- marked.js: MarkdownをHTMLに変換するライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- microCMS JavaScript SDK: microCMSからデータを取得するためのライブラリ -->
    <script src="https://unpkg.com/microcms-js-sdk@latest/dist/umd/microcms-js-sdk.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* 日本語フォントと基本的なスタイルを適用 */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: #333; /* 基本の文字色を濃いグレーに */
        }

        /* Markdownから変換されたHTML要素のスタイル調整 */
        .prose h1 {
            font-size: 1.875rem; /* text-3xl */
            line-height: 2.5rem;
            font-weight: 700;
            color: #1f2937; /* text-gray-800 */
            margin-bottom: 0.75rem; /* 12px */
            padding-bottom: 0;
            border-bottom: none;
        }
        @media (min-width: 768px) {
            .prose h1 {
                font-size: 2.25rem; /* md:text-4xl */
                line-height: 2.75rem;
            }
        }

        .prose h2 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700;
            color: #111827; /* text-gray-900 */
            margin-top: 3rem;
            margin-bottom: 1.5rem;
            padding-left: 1rem;
            border-left: 5px solid #60a5fa; /* A nice blue color */
            border-bottom: none;
        }

        .prose h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700;
            color: #111827; /* text-gray-900 */
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
        }

        .prose p {
            font-size: 1rem;
            line-height: 1.9;
            margin-bottom: 1.25rem;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.75rem;
            margin-bottom: 1.25rem;
        }

        .prose li {
            margin-bottom: 0.75rem;
            line-height: 1.9;
        }

        .prose strong {
            font-weight: 700;
            color: #111827; /* text-gray-900 */
        }

        .prose a {
            color: #2563eb; /* blue-600 */
            text-decoration: underline;
        }
        
        .prose blockquote {
            border-left: 4px solid #d1d5db;
            padding-left: 1rem;
            color: #6b7280;
            margin-bottom: 1.25rem;
        }
    </style>
</head>
<body class="bg-gray-50">

    <main class="container mx-auto max-w-4xl px-4 py-8 sm:py-12">
        <article id="article-container" class="prose max-w-none bg-white p-6 sm:p-8 md:p-12 rounded-lg shadow-md">
            <!-- タイトル、公開日、概要 -->
            <div class="not-prose mb-10 pb-8 border-b border-gray-200">
                <div id="article-meta">
                    <h1 id="article-title" class="text-gray-400">データを読み込み中...</h1>
                    <time id="article-published-at" class="block mt-4 text-gray-500 text-base"></time>
                    <p id="article-description" class="mt-6 text-gray-700 text-base leading-relaxed"></p>
                </div>
            </div>
            
            <!-- 本文 -->
            <div id="article-body" class="text-gray-400">
                <p>microCMSからプレビューデータを取得しています。しばらくお待ちください。</p>
            </div>

            <!-- 監修者 -->
            <div id="article-supervisor-container" class="hidden mt-12 pt-6 border-t border-gray-200">
                <p class="text-sm text-gray-600">監修</p>
                <p id="article-supervisor" class="text-base font-bold text-gray-800 mt-1"></p>
            </div>
        </article>
    </main>

    <script>
        // --- 設定項目 ---
        const SERVICE_DOMAIN = 'anicure-dev'; 
        const API_KEY = '89b2759d3aa84128a5726ccf46c4fa605b07';
        const API_ENDPOINT = 'articles';
        
        // --- フィールドIDの設定（ご自身のAPIスキーマに合わせてください） ---
        const TITLE_FIELD_ID = 'title';
        const DESCRIPTION_FIELD_ID = 'description';
        const BODY_FIELD_ID = 'body';
        const SUPERVISOR_FIELD_ID = 'supervisor';
        const PUBLISHED_AT_FIELD_ID = 'publishedAt'; // microCMSのデフォルトフィールド
        // --- 設定はここまで ---

        const client = microcms.createClient({
            serviceDomain: SERVICE_DOMAIN,
            apiKey: API_KEY,
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const titleElement = document.getElementById('article-title');
            const publishedAtElement = document.getElementById('article-published-at');
            const descriptionElement = document.getElementById('article-description');
            const bodyElement = document.getElementById('article-body');
            const supervisorContainer = document.getElementById('article-supervisor-container');
            const supervisorElement = document.getElementById('article-supervisor');

            try {
                const params = new URLSearchParams(window.location.search);
                const contentId = params.get('contentId');
                const draftKey = params.get('draftKey');

                if (!contentId || !draftKey) {
                    throw new Error('プレビュー用のパラメータが見つかりません。');
                }

                const data = await client.get({
                    endpoint: API_ENDPOINT,
                    contentId: contentId,
                    queries: { draftKey: draftKey },
                });

                // 1. タイトルを設定
                if (data[TITLE_FIELD_ID]) {
                    titleElement.textContent = data[TITLE_FIELD_ID];
                    titleElement.classList.remove('text-gray-400');
                } else {
                    titleElement.textContent = 'タイトルの取得に失敗';
                }

                // 2. 公開日を設定
                if (data[PUBLISHED_AT_FIELD_ID]) {
                    const date = new Date(data[PUBLISHED_AT_FIELD_ID]);
                    const formattedDate = `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
                    publishedAtElement.textContent = `公開日: ${formattedDate}`;
                    publishedAtElement.setAttribute('datetime', data[PUBLISHED_AT_FIELD_ID]);
                }

                // 3. 概要を設定
                if (data[DESCRIPTION_FIELD_ID]) {
                    descriptionElement.textContent = data[DESCRIPTION_FIELD_ID];
                }

                // 4. 本文（Markdown）をHTMLに変換して設定
                if (data[BODY_FIELD_ID]) {
                    bodyElement.innerHTML = marked.parse(data[BODY_FIELD_ID]);
                    bodyElement.classList.remove('text-gray-400');
                } else {
                    bodyElement.innerHTML = '<p>本文の取得に失敗しました。フィールドIDが正しいか確認してください。</p>';
                }

                // 5. 監修者を設定 (★デバッグ機能を追加して修正しました)
                if (data[SUPERVISOR_FIELD_ID]) {
                    const supervisorData = data[SUPERVISOR_FIELD_ID];
                    let supervisorName = '';

                    // supervisorDataが存在し、オブジェクト形式の場合 (コンテンツ参照)
                    if (typeof supervisorData === 'object' && supervisorData !== null) {
                        // 一般的な名前フィールドを試す (name, titleなど)
                        if (supervisorData.name) {
                            supervisorName = supervisorData.name;
                        } else if (supervisorData.title) { // 'title'フィールドも試す
                            supervisorName = supervisorData.title;
                        } else {
                            // オブジェクトの構造をコンソールに出力してデバッグしやすくする
                            console.log('監修者オブジェクトの内容:', supervisorData);
                            supervisorName = '監修者名の取得に失敗しました (詳細はコンソールを確認)';
                        }
                    } 
                    // supervisorDataが単純なテキストの場合
                    else if (typeof supervisorData === 'string') {
                        supervisorName = supervisorData;
                    }

                    // 監修者名が取得できた場合のみ表示
                    if (supervisorName) {
                        supervisorElement.textContent = supervisorName;
                        supervisorContainer.classList.remove('hidden');
                    }
                }

            } catch (error) {
                console.error('プレビューの読み込みに失敗しました:', error);
                titleElement.textContent = 'エラーが発生しました';
                bodyElement.innerHTML = `<p>プレビューの読み込みに失敗しました。</p><p class="text-sm text-red-600">エラー内容: ${error.message}</p><p class="text-sm mt-4">設定項目（サービスドメイン、APIキー、エンドポイント名、各フィールドID）が正しいか確認してください。</p>`;
            }
        });
    </script>
</body>
</html>
