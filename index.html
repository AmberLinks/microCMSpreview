<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>microCMS プレビュー</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="https://unpkg.com/microcms-js-sdk@latest/dist/umd/microcms-js-sdk.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: #333;
            background-color: #f9fafb;
        }
        .prose h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 3.5rem;
            margin-bottom: 1.5rem;
            padding-left: 1rem;
            border-left: 5px solid #3b82f6;
        }
        .prose h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-top: 3rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }
        .prose p { line-height: 2; }
        .prose a { color: #2563eb; text-decoration: underline; }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto max-w-5xl px-4 py-4">
            <h1 class="text-xl font-bold text-gray-700">記事プレビュー</h1>
        </div>
    </header>

    <main class="container mx-auto max-w-4xl px-4 py-8 sm:py-16">
        <article id="article-container" class="prose max-w-none bg-white p-6 sm:p-10 md:p-12 rounded-xl shadow-lg">
            <div class="not-prose mb-10 pb-8 border-b border-gray-200">
                <div id="article-meta">
                    <h1 id="article-title" class="text-gray-400 text-3xl md:text-4xl font-bold">データを読み込み中...</h1>
                    <time id="article-published-at" class="block mt-4 text-gray-500 text-base"></time>
                    <p id="article-description" class="mt-6 text-gray-600 text-lg leading-relaxed"></p>
                </div>
            </div>

            <div id="toc-container" class="not-prose hidden mb-12 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                <h2 class="text-lg font-bold mb-4 flex items-center text-blue-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
                    目次
                </h2>
                <ol id="table-of-contents" class="space-y-2"></ol>
            </div>

            <div id="article-body" class="text-gray-400">
                <p>microCMSからプレビューデータを取得しています。しばらくお待ちください。</p>
            </div>

            <div id="article-supervisor-container" class="hidden not-prose mt-16 pt-8 border-t border-gray-200">
                <div class="bg-gray-50 p-6 rounded-lg">
                    <div class="flex items-start space-x-6">
                        <div class="flex-shrink-0">
                            <img id="supervisor-icon" src="" alt="監修者アイコン" class="h-24 w-24 rounded-full object-cover border-4 border-white shadow-md">
                        </div>
                        <div class="flex-1">
                            <p id="supervisor-label" class="text-sm font-semibold text-gray-600">この記事を監修した専門家</p>
                            <h3 id="supervisor-name" class="text-xl font-bold text-gray-800 mt-1"></h3>
                            <p id="supervisor-description" class="text-gray-700 mt-3 text-sm leading-relaxed"></p>
                            <a id="supervisor-link" href="#" class="inline-block mt-4 text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors">
                                詳しくはこちら &rarr;
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </article>
    </main>

    <footer class="bg-gray-800 text-white mt-16 py-6">
        <div class="container mx-auto max-w-5xl px-4 text-center text-sm">
            &copy; 2023 My Website. All Rights Reserved.
        </div>
    </footer>

    <script>
        // --- 設定項目 ---
        const SERVICE_DOMAIN = 'anicure-dev';
        const API_KEY = '89b2759d3aa84128a5726ccf46c4fa605b07';
        
        const ARTICLE_ENDPOINT = 'articles';
        const STAFF_ENDPOINT = 'staff'; // スタッフ情報のエンドポイント

        // --- フィールドIDの設定 ---
        const TITLE_FIELD_ID = 'title';
        const DESCRIPTION_FIELD_ID = 'description';
        const BODY_FIELD_ID = 'body';
        const SUPERVISOR_FIELD_ID = 'supervisor'; // 記事内の監修者フィールドID
        const PUBLISHED_AT_FIELD_ID = 'publishedAt';

        const client = microcms.createClient({
            serviceDomain: SERVICE_DOMAIN,
            apiKey: API_KEY,
        });

        const createTableOfContents = (bodyElement) => {
            const tocContainer = document.getElementById('toc-container');
            const tocList = document.getElementById('table-of-contents');
            tocList.innerHTML = '';
            const headings = bodyElement.querySelectorAll('h2, h3');
            if (headings.length === 0) {
                tocContainer.classList.add('hidden');
                return;
            }
            headings.forEach((heading, index) => {
                const id = `toc-${index}`;
                heading.id = id;
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#${id}`;
                a.textContent = heading.textContent;
                a.className = "hover:underline";
                if (heading.tagName === 'H2') li.classList.add('font-semibold', 'text-blue-700');
                else if (heading.tagName === 'H3') li.classList.add('ml-4', 'text-blue-600');
                li.appendChild(a);
                tocList.appendChild(li);
            });
            tocContainer.classList.remove('hidden');
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const titleElement = document.getElementById('article-title');
            const publishedAtElement = document.getElementById('article-published-at');
            const descriptionElement = document.getElementById('article-description');
            const bodyElement = document.getElementById('article-body');

            try {
                const params = new URLSearchParams(window.location.search);
                const contentId = params.get('contentId');
                const draftKey = params.get('draftKey');

                if (!contentId || !draftKey) {
                    throw new Error('プレビュー用のパラメータが見つかりません。');
                }

                // 1. 記事データを取得
                const articleData = await client.get({
                    endpoint: ARTICLE_ENDPOINT,
                    contentId: contentId,
                    queries: { draftKey: draftKey },
                });

                // 記事の基本情報を設定
                titleElement.textContent = articleData[TITLE_FIELD_ID] || 'タイトルの取得に失敗';
                if(articleData[TITLE_FIELD_ID]) titleElement.classList.remove('text-gray-400');
                
                if (articleData[PUBLISHED_AT_FIELD_ID]) {
                    const date = new Date(articleData[PUBLISHED_AT_FIELD_ID]);
                    publishedAtElement.textContent = `公開日: ${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
                }
                
                descriptionElement.textContent = articleData[DESCRIPTION_FIELD_ID] || '';
                
                if (articleData[BODY_FIELD_ID]) {
                    bodyElement.innerHTML = marked.parse(articleData[BODY_FIELD_ID]);
                    bodyElement.classList.remove('text-gray-400');
                    createTableOfContents(bodyElement);
                } else {
                    bodyElement.innerHTML = '<p>本文の取得に失敗しました。</p>';
                }

                // ★★★ 2. 監修者情報を取得して表示 ★★★
                if (articleData[SUPERVISOR_FIELD_ID] && articleData[SUPERVISOR_FIELD_ID].id) {
                    const supervisorId = articleData[SUPERVISOR_FIELD_ID].id;

                    // 記事データから取得したIDを使って、staffエンドポイントから詳細情報を取得
                    const staffData = await client.get({
                        endpoint: STAFF_ENDPOINT,
                        contentId: supervisorId,
                    });
                    
                    // 取得したデータをHTML要素にセット
                    const supervisorContainer = document.getElementById('article-supervisor-container');
                    const iconEl = document.getElementById('supervisor-icon');
                    const labelEl = document.getElementById('supervisor-label');
                    const nameEl = document.getElementById('supervisor-name');
                    const descriptionEl = document.getElementById('supervisor-description');
                    
                    if (staffData.anicureThumbnail && staffData.anicureThumbnail.url) {
                        iconEl.src = staffData.anicureThumbnail.url;
                    }
                    
                    const role = (staffData.anicureRole && staffData.anicureRole.length > 0) ? staffData.anicureRole.join(' / ') : '';
                    if(role) {
                        labelEl.textContent = `この記事を監修した${role}`;
                        nameEl.textContent = `${staffData.name || ''} ${role}`;
                    } else {
                        nameEl.textContent = staffData.name || '';
                    }

                    descriptionEl.textContent = staffData.anicureDescription || '';
                    
                    // コンテナを表示
                    supervisorContainer.classList.remove('hidden');
                }

            } catch (error) {
                console.error('プレビューの読み込みに失敗しました:', error);
                const articleContainer = document.getElementById('article-container');
                articleContainer.innerHTML = `<div class="text-center"><h1 class="text-2xl font-bold text-red-600">エラーが発生しました</h1><p class="mt-4">プレビューの読み込みに失敗しました。</p><p class="mt-2 text-sm text-red-500 bg-red-50 p-4 rounded-md">エラー内容: ${error.message}</p></div>`;
            }
        });
    </script>
</body>
</html>
